<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Pro - Fix Double Pulang</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { 
            --primary: #4361ee; --success: #2ecc71; --danger: #ef233c; 
            --bg: #f8f9fa; --card: #ffffff; --text-main: #2b2d42; --text-muted: #8d99ae;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; background: var(--card); border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid rgba(0,0,0,0.03); }
        .tabs { display: flex; background: #f1f3f5; padding: 8px; margin: 15px; border-radius: 16px; }
        .tab-btn { flex: 1; padding: 12px; border: none; cursor: pointer; font-weight: 600; color: var(--text-muted); background: transparent; border-radius: 12px; transition: 0.3s; }
        .tab-btn.active { background: var(--card); color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .content { padding: 0 20px 25px 20px; display: none; }
        .content.active { display: block; }
        #reader { border-radius: 20px; overflow: hidden; background: #000; margin-bottom: 20px; border: 4px solid #f1f3f5; }
        #statusJarak { text-align: center; font-size: 0.85rem; margin-bottom: 15px; font-weight: 600; padding: 10px; border-radius: 12px; }
        .di-luar { background: #fff3f3; color: var(--danger); border: 1px solid #ffe3e3; }
        .di-dalam { background: #f0fff4; color: var(--success); border: 1px solid #c6f6d5; }
        #infoScan { background: #f8f9fa; padding: 15px; border-radius: 15px; text-align: center; margin-bottom: 20px; border: 1px dashed #dee2e6; }
        .btn-group { display: flex; gap: 12px; margin-bottom: 25px; }
        .btn-absen { flex: 1; padding: 16px; border-radius: 16px; border: none; font-weight: 700; cursor: pointer; color: white; transition: 0.2s; box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .btn-absen.masuk { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .btn-absen.pulang { background: linear-gradient(135deg, #ef233c, #d90429); }
        .btn-absen.locked { opacity: 0.5; cursor: not-allowed; box-shadow: none; filter: grayscale(0.8); }
        table { width: 100%; border-collapse: collapse; }
        th { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; padding: 12px 8px; border-bottom: 2px solid #f1f3f5; text-align: left; }
        td { padding: 14px 8px; font-size: 0.9rem; border-bottom: 1px solid #f1f3f5; }
        .badge { padding: 5px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 700; color: white; }
        input { width: 100%; padding: 14px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #dee2e6; background: #f8f9fa; box-sizing: border-box; }
        .btn-primary { background: var(--primary); color: white; width: 100%; padding: 15px; border: none; border-radius: 14px; font-weight: 700; cursor: pointer; }
        .btn-action { padding: 8px 12px; border-radius: 8px; border: none; color: white; font-weight: 600; font-size: 0.7rem; cursor: pointer; margin-right: 4px; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button id="tabAbsenBtn" class="tab-btn active" onclick="openTab('tab-absen')">Absensi</button>
        <button id="tabPegawaiBtn" class="tab-btn" onclick="openTab('tab-admin')">Pegawai</button>
    </div>

    <div id="tab-absen" class="content active">
        <div id="reader"></div>
        <div id="statusJarak">Mendeteksi Lokasi...</div>
        <div id="infoScan">Silakan Scan QR Pegawai</div>
        <div class="btn-group">
            <button id="btnIn" class="btn-absen masuk" onclick="prosesAbsen('Masuk')">MASUK</button>
            <button id="btnOut" class="btn-absen pulang" onclick="prosesAbsen('Pulang')">PULANG</button>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
            <h4 style="margin:0">Log Hari Ini</h4>
            <button style="background:white; color:var(--success); border:1px solid var(--success); padding:5px 10px; border-radius:8px; cursor:pointer; font-weight:600;" onclick="exportExcelAbsensi()">ðŸ“Š Laporan</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>NAMA</th>
                    <th>DIVISI</th>
                    <th>JAM</th>
                    <th>KET</th>
                </tr>
            </thead>
            <tbody id="logAbsen"></tbody>
        </table>
    </div>

    <div id="tab-admin" class="content">
        <h3 style="margin-top:0">Tambah Pegawai</h3>
        <input type="text" id="regNama" placeholder="Nama Lengkap Pegawai...">
        <input type="text" id="regDivisi" placeholder="Divisi (Contoh: IT, Marketing, HR)..." style="margin-bottom:10px;">
        <button class="btn-primary" onclick="simpanPegawai()">+ Daftarkan Pegawai</button>
        <div id="qrcode-container" style="display:none; text-align:center; margin-top:20px; padding:20px; background:#f8f9fa; border-radius:15px; border:2px dashed #dee2e6;">
            <div id="qrcode" style="display:flex; justify-content:center;"></div>
            <p id="qrLabel" style="font-weight:bold; margin:15px 0; color:var(--primary);"></p>
            <button class="btn-primary" style="width:auto; padding:8px 20px" onclick="window.print()">Cetak QR</button>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:30px; margin-bottom: 10px;">
            <h4 style="margin:0">Daftar Pegawai</h4>
            <button style="background:white; color:#2ecc71; border:1px solid #2ecc71; padding:5px 10px; border-radius:8px; cursor:pointer; font-weight:600; display: flex; align-items: center; gap: 5px;" onclick="exportExcelPegawai()">
                ðŸ“Š Export Pegawai
            </button>
        </div>
        <!-- <h4 style="margin-top:30px">Daftar Pegawai</h4> -->
        <table id="listPegawai"></table>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCMu-Bfd1GQWIoT1CnInPtWcIDCJkhSIgQ",
        authDomain: "absensi-kantor-cf8b7.firebaseapp.com",
        databaseURL: "https://absensi-kantor-cf8b7-default-rtdb.firebaseio.com",
        projectId: "absensi-kantor-cf8b7",
        storageBucket: "absensi-kantor-cf8b7.firebasestorage.app",
        messagingSenderId: "287648038826",
        appId: "1:287648038826:web:15c9e546d66162980f75d3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    const LAT_KANTOR = -7.716846501344563; 
    const LON_KANTOR = 112.06776955014226; 
    const MAX_JARAK = 100; 
    
    let namaTerdeteksi = "";
    let jarakSekarang = 9999;
    window.cekAbsen = { masuk: false, pulang: false };

    function bicara(teks) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(teks);
        msg.lang = 'id-ID';
        window.speechSynthesis.speak(msg);
    }

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const dLat = (lat2-lat1) * Math.PI/180;
        const dLon = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    if (navigator.geolocation) {
        navigator.geolocation.watchPosition((position) => {
            jarakSekarang = getDistance(position.coords.latitude, position.coords.longitude, LAT_KANTOR, LON_KANTOR);
            const elStatus = document.getElementById('statusJarak');
            if (jarakSekarang <= MAX_JARAK) {
                elStatus.innerHTML = `âœ… Dalam Jangkauan (${Math.round(jarakSekarang)}m)`;
                elStatus.className = "di-dalam";
            } else {
                elStatus.innerHTML = `âš ï¸ Luar Jangkauan (${Math.round(jarakSekarang)}m)`;
                elStatus.className = "di-luar";
            }
        }, null, { enableHighAccuracy: true });
    }

    function openTab(id) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById(id === 'tab-absen' ? 'tabAbsenBtn' : 'tabPegawaiBtn').classList.add('active');
    }

    db.ref('log_absen').on('value', (snap) => {
    let html = "";
    let arr = [];
    const tglHariIni = new Date().toLocaleDateString('id-ID');

    // 1. Ambil data semua pegawai dulu untuk mencari divisinya
    db.ref('pegawai').once('value', (pegawaiSnap) => {
        const daftarDivisi = {};
        pegawaiSnap.forEach(p => {
            daftarDivisi[p.val().nama] = p.val().divisi; 
        });

        // 2. Filter log absen untuk hari ini
        snap.forEach(c => {
            const d = c.val();
            if(new Date(d.ts).toLocaleDateString('id-ID') === tglHariIni) arr.push(d);
        });

                // Ganti baris 173 - 189 di image_367057.png dengan ini:
        arr.reverse().forEach(i => {
            let warna = i.status === "Terlambat" ? "var(--danger)" : "var(--success)";
            if(i.tipe === "Pulang") warna = "var(--primary)";
            
            // Ambil divisi saja tanpa kurung
            const div = daftarDivisi[i.nama] || "-";

            html += `<tr>
                <td>
                    <b>${i.nama}</b><br>
                    <small style="color:gray;">${i.tipe}</small>
                </td>
                <td style="vertical-align: middle;">${div}</td>
                <td style="vertical-align: middle;">${i.waktu}</td>
                <td style="vertical-align: middle;">
                    <span class="badge" style="background:${warna}">${i.status || '-'}</span>
                </td>
            </tr>`;
        });

        // Update colspan menjadi 4 karena sekarang ada 4 kolom
        document.getElementById('logAbsen').innerHTML = html || "<tr><td colspan='4' style='text-align:center'>Belum ada aktivitas</td></tr>";

        // // 3. Render tabel
        // arr.reverse().forEach(i => {
        //     let warna = i.status === "Terlambat" ? "var(--danger)" : "var(--success)";
        //     if(i.tipe === "Pulang") warna = "var(--primary)";
            
        //     // Ambil divisi berdasarkan nama, jika tidak ada tampilkan strip
        //     const div = daftarDivisi[i.nama] ? ` (${daftarDivisi[i.nama]})` : "";

        //     html += `<tr>
        //         <td>
        //             <b>${i.nama}${div}</b><br>
        //             <small style="color:gray;">${i.tipe}</small>
        //         </td>
        //         <td>${i.waktu}</td>
        //         <td><span class="badge" style="background:${warna}">${i.status || '-'}</span></td>
        //     </tr>`;
        // });
        // document.getElementById('logAbsen').innerHTML = html || "<tr><td colspan='3' style='text-align:center'>Belum ada aktivitas</td></tr>";
    });
});

    // db.ref('log_absen').on('value', (snap) => {
    //     let html = ""; let arr = [];
    //     const tglHariIni = new Date().toLocaleDateString('id-ID');
    //     snap.forEach(c => {
    //         const d = c.val();
    //         if(new Date(d.ts).toLocaleDateString('id-ID') === tglHariIni) arr.push(d);
    //     });
    //     arr.reverse().forEach(i => {
    //         let warna = i.status === "Terlambat" ? "var(--danger)" : "var(--success)";
    //         if(i.tipe === "Pulang") warna = "var(--primary)";
    //         html += `<tr><td><b>${i.nama}</b><br><small>${i.tipe}</small></td><td>${i.waktu}</td><td><span class="badge" style="background:${warna}">${i.status || '-'}</span></td></tr>`;
    //     });
    //     document.getElementById('logAbsen').innerHTML = html || "<tr><td colspan='3' style='text-align:center'>Belum ada aktivitas</td></tr>";
    // });

    // Tambahkan variabel timer di bagian atas
    let logoutTimer;

    function resetSesi() {
        // Fungsi untuk membersihkan identitas pegawai dari layar
        namaTerdeteksi = "";
        window.cekAbsen = { masuk: false, pulang: false };
        document.getElementById('infoScan').innerHTML = `<span style="color: var(--text-muted);">Silakan Scan QR Terlebih Dahulu</span>`;
        updateButtonVisual();
        console.log("Sesi telah direset otomatis.");
    }

    function checkStatusAbsen(nama) {
        // Setiap kali ada scan baru, batalkan timer reset yang lama
        clearTimeout(logoutTimer);
        
        namaTerdeteksi = nama;
        const tglHariIni = new Date().toLocaleDateString('id-ID');
        db.ref('log_absen').once('value', (snap) => {
            let sdhM = false; let sdhP = false;
            snap.forEach(c => {
                const log = c.val();
                if(log.nama === nama && new Date(log.ts).toLocaleDateString('id-ID') === tglHariIni) {
                    if(log.tipe === "Masuk") sdhM = true;
                    if(log.tipe === "Pulang") sdhP = true;
                }
            });
            window.cekAbsen = { masuk: sdhM, pulang: sdhP };
            updateButtonVisual();
            document.getElementById('infoScan').innerHTML = `Pegawai: <b style="color:var(--primary)">${nama}</b>`;
            
            // Mulai hitung mundur 15 detik. Jika tidak ada aktivitas, data hilang.
            logoutTimer = setTimeout(resetSesi, 5000); 
        });
    }

    // function checkStatusAbsen(nama) {
    //     namaTerdeteksi = nama;
    //     const tglHariIni = new Date().toLocaleDateString('id-ID');
    //     db.ref('log_absen').once('value', (snap) => {
    //         let sdhM = false; let sdhP = false;
    //         snap.forEach(c => {
    //             const log = c.val();
    //             if(log.nama === nama && new Date(log.ts).toLocaleDateString('id-ID') === tglHariIni) {
    //                 if(log.tipe === "Masuk") sdhM = true;
    //                 if(log.tipe === "Pulang") sdhP = true;
    //             }
    //         });
    //         window.cekAbsen = { masuk: sdhM, pulang: sdhP };
    //         updateButtonVisual();
    //         document.getElementById('infoScan').innerHTML = `Pegawai: <b style="color:var(--primary)">${nama}</b>`;
    //     });
    // }

    function updateButtonVisual() {
        const btnIn = document.getElementById('btnIn');
        const btnOut = document.getElementById('btnOut');
        
        // Kunci Masuk jika sudah masuk
        if(window.cekAbsen.masuk) btnIn.classList.add('locked'); else btnIn.classList.remove('locked');
        
        // Kunci Pulang jika belum masuk ATAU sudah pulang
        if(!window.cekAbsen.masuk || window.cekAbsen.pulang) btnOut.classList.add('locked'); else btnOut.classList.remove('locked');
    }

    function prosesAbsen(tipe) {
        if (!namaTerdeteksi) { alert("Scan QR Terlebih Dahulu!"); return; }
        
        // Batalkan timer reset karena ada aktivitas klik tombol
        clearTimeout(logoutTimer);

        if (jarakSekarang > MAX_JARAK) {
            bicara(`Maaf ${namaTerdeteksi}, Anda berada di luar jangkauan.`);
            logoutTimer = setTimeout(resetSesi, 3000); // Reset cepat jika gagal
            return;
        }

        if (tipe === "Masuk" && window.cekAbsen.masuk) {
            bicara(`Maaf ${namaTerdeteksi}, Anda sudah absen masuk.`);
            logoutTimer = setTimeout(resetSesi, 3000);
            return;
        }

        if (tipe === "Pulang" && (window.cekAbsen.pulang || !window.cekAbsen.masuk)) {
            bicara(`Maaf ${namaTerdeteksi}, Anda sudah absen pulang.`);
            logoutTimer = setTimeout(resetSesi, 3000);
            return;
        }

        const skrg = new Date();
        const jamStr = skrg.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false });
        let status = tipe === "Masuk" ? (jamStr > "08:00" ? "Terlambat" : "Tepat Waktu") : "Selesai";

        db.ref('log_absen').push({
            nama: namaTerdeteksi, tipe: tipe, waktu: jamStr, status: status, ts: Date.now()
        }).then(() => {
            bicara(`Berhasil absen ${tipe}, ${namaTerdeteksi}.`);
            alert(`Absen ${tipe} Berhasil!`);
            
            // SETELAH BERHASIL ABSEN: Langsung reset data dalam 2 detik
            setTimeout(resetSesi, 2000); 
        });
    }

    // function prosesAbsen(tipe) {
    //     if (!namaTerdeteksi) { alert("Scan QR Terlebih Dahulu!"); return; }
        
    //     if (jarakSekarang > MAX_JARAK) {
    //         bicara(`Maaf ${namaTerdeteksi}, Anda berada di luar jangkauan, mohon mendekat ke kantor.`);
    //         return;
    //     }

    //     // VALIDASI KETAT
    //     if (tipe === "Masuk" && window.cekAbsen.masuk) {
    //         bicara(`Maaf ${namaTerdeteksi}, Anda sudah absen masuk.`);
    //         return;
    //     }

    //     if (tipe === "Pulang") {
    //         if (!window.cekAbsen.masuk) {
    //             bicara(`Maaf ${namaTerdeteksi}, Anda belum absen masuk hari ini.`);
    //             return;
    //         }
    //         if (window.cekAbsen.pulang) {
    //             bicara(`Maaf ${namaTerdeteksi}, Anda sudah absen pulang hari ini.`);
    //             return;
    //         }
    //     }

    //     const skrg = new Date();
    //     const jamStr = skrg.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false });
    //     let status = tipe === "Masuk" ? (jamStr > "08:00" ? "Terlambat" : "Tepat Waktu") : "Selesai";

    //     db.ref('log_absen').push({
    //         nama: namaTerdeteksi, tipe: tipe, waktu: jamStr, status: status, ts: Date.now()
    //     }).then(() => {
    //         bicara(`Berhasil absen ${tipe}, ${namaTerdeteksi}.`);
    //         // Update status lokal secara instan agar tombol langsung terkunci
    //         if(tipe === "Masuk") window.cekAbsen.masuk = true;
    //         if(tipe === "Pulang") window.cekAbsen.pulang = true;
    //         updateButtonVisual();
            
    //         alert(`Absen ${tipe} Berhasil!`);
    //     });
    // }

    let scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
    scanner.render((txt) => { checkStatusAbsen(txt); });

    // Fungsi Render Daftar Pegawai dengan No Urut & Urutan Terlama -> Terbaru
db.ref('pegawai').on('value', (snap) => {
    let html = "";
    let no = 1; // Inisialisasi nomor urut

    // Render langsung dari Firebase (Firebase secara default memberikan urutan berdasarkan waktu input/terlama ke terbaru)
    snap.forEach(c => {
        const d = c.val();
        html += `<tr>
            <td style="padding: 10px;">${no++}.</td> 
            <td>
                <b>${d.nama}</b><br>
                <small style="color:gray;">Divisi: ${d.divisi || '-'}</small>
            </td>
            <td style="text-align: right;">
                <button class="btn-action" style="background:#f1c40f" onclick="editPegawai('${c.key}', '${d.nama}')">Edit</button>
                <button class="btn-action" style="background:#e74c3c" onclick="hapusPegawai('${c.key}')">Hapus</button>
                <button class="btn-action" style="background:#2ecc71" onclick="tampilQR('${d.nama}')">QR</button>
            </td>
        </tr>`;
    });
    
    document.getElementById('listPegawai').innerHTML = html || "<tr><td colspan='3' style='text-align:center'>Belum ada pegawai terdaftar</td></tr>";
});

    // Fungsi Admin Tetap Sama
    // db.ref('pegawai').on('value', (snap) => {
    //     let html = "";
    //     snap.forEach(c => {
    //         const d = c.val();
    //         html += `<tr><td><b>${d.nama}</b></td><td>
    //             <button class="btn-action" style="background:#f1c40f" onclick="editPegawai('${c.key}', '${d.nama}')">Edit</button>
    //             <button class="btn-action" style="background:#e74c3c" onclick="hapusPegawai('${c.key}')">Hapus</button>
    //             <button class="btn-action" style="background:#2ecc71" onclick="tampilQR('${d.nama}')">QR</button>
    //         </td></tr>`;
    //     });
    //     document.getElementById('listPegawai').innerHTML = html;
    // });

    // function simpanPegawai() {
    //     const n = document.getElementById('regNama').value.trim();
    //     if(n) db.ref('pegawai').push({ nama: n }).then(() => {
    //         document.getElementById('regNama').value = "";
    //         tampilQR(n);
    //     });
    // }
    function simpanPegawai() {
    const n = document.getElementById('regNama').value.trim();
    const d = document.getElementById('regDivisi').value.trim(); // Ambil nilai divisi
    
    if(n && d) { // Pastikan keduanya diisi
        db.ref('pegawai').push({ 
            nama: n, 
            divisi: d // Simpan divisi ke database
        }).then(() => {
            document.getElementById('regNama').value = "";
            document.getElementById('regDivisi').value = ""; // Kosongkan input
            tampilQR(n);
        });
    } else {
        alert("Mohon isi Nama dan Divisi!");
        }
    }
    function editPegawai(k, n) { const b = prompt("Ubah Nama:", n); if(b) db.ref('pegawai/' + k).update({ nama: b }); }
    function hapusPegawai(k) { if(confirm("Hapus?")) db.ref('pegawai/' + k).remove(); }
    function tampilQR(n) {
        document.getElementById('qrcode-container').style.display = "block";
        document.getElementById('qrcode').innerHTML = "";
        new QRCode(document.getElementById('qrcode'), { text: n, width: 150, height: 150 });
        document.getElementById('qrLabel').innerText = n;
    }
    // function exportExcelAbsensi() {
    //     db.ref('log_absen').once('value', (snap) => {
    //         let data = [];
    //         snap.forEach(c => {
    //             const i = c.val();
    //             data.push({ Tanggal: new Date(i.ts).toLocaleDateString('id-ID'), Nama: i.nama, Tipe: i.tipe, Jam: i.waktu, Keterangan: i.status });
    //         });
    //         const ws = XLSX.utils.json_to_sheet(data);
    //         const wb = XLSX.utils.book_new();
    //         XLSX.utils.book_append_sheet(wb, ws, "Riwayat");
    //         XLSX.writeFile(wb, "Laporan_Absen.xlsx");
    //     });
    // }

    function exportExcelAbsensi() {
    db.ref('log_absen').once('value', (snap) => {
        let data = [];
        const tglHariIni = new Date().toLocaleDateString('id-ID');

        // 1. Ambil data pegawai untuk referensi divisi
        db.ref('pegawai').once('value', (pegawaiSnap) => {
            const daftarDivisi = {};
            pegawaiSnap.forEach(p => {
                daftarDivisi[p.val().nama] = p.val().divisi;
            });

            // 2. Filter log untuk hari ini saja
            snap.forEach(c => {
                const d = c.val();
                if (new Date(d.ts).toLocaleDateString('id-ID') === tglHariIni) {
                    data.push({
                        "Waktu": d.waktu,
                        "Nama": d.nama,
                        "Divisi": daftarDivisi[d.nama] || "-", // Menambahkan kolom Divisi
                        "Tipe": d.tipe,
                        "Status": d.status || "-"
                    });
                }
            });

            if (data.length === 0) {
                alert("Tidak ada data absen hari ini untuk diekspor!");
                return;
            }

            // 3. Proses menjadi file Excel
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Laporan Absensi");
            XLSX.writeFile(wb, `Laporan_Absen_${tglHariIni.replace(/\//g, '-')}.xlsx`);
        });
    });
    }

    function exportExcelPegawai() {
    db.ref('pegawai').once('value', (snap) => {
        let data = [];
        let no = 1;
        snap.forEach(c => {
            const p = c.val();
            data.push({
                "No": no++,
                "Nama Pegawai": p.nama,
                "Divisi": p.divisi || "-", // TAMBAHKAN BARIS INI
                "ID Database": c.key
            });
        });
        
        if(data.length === 0) {
            alert("Data pegawai masih kosong!");
            return;
        }

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Daftar Pegawai");
        // Simpan file dengan nama Daftar_Pegawai.xlsx
        XLSX.writeFile(wb, "Daftar_Pegawai.xlsx");
    });
}
// Fungsi Modul Export Daftar Pegawai
// function exportExcelPegawai() {
//     db.ref('pegawai').once('value', (snap) => {
//         let data = [];
//         let no = 1;
//         snap.forEach(c => {
//             const p = c.val();
//             data.push({ 
//                 "No": no++, 
//                 "Nama Pegawai": p.nama, 
//                 "ID Database": c.key 
//             });
//         });

//         if(data.length === 0) {
//             alert("Data pegawai masih kosong!");
//             return;
//         }

//         const ws = XLSX.utils.json_to_sheet(data);
//         const wb = XLSX.utils.book_new();
//         XLSX.utils.book_append_sheet(wb, ws, "Daftar Pegawai");
        
//         // Simpan file dengan nama Daftar_Pegawai.xlsx
//         XLSX.writeFile(wb, "Daftar_Pegawai.xlsx");
//     });
// }
</script>
</body>
</html>